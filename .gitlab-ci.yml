stages:
  - validate
  - deploy

haproxy-check:
  stage: validate
  tags:
    - shell-office-shared-runner
  script:
    - echo "Checking HAProxy configuration syntax..."
    - docker run --rm --entrypoint haproxy -v $PWD/ansible/roles/haproxy/files/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro haproxy:3.0-alpine -c -f /usr/local/etc/haproxy/haproxy.cfg
    - echo "HAProxy config syntax is VALID"

    - echo "Starting HAProxy container for health check..."
    - docker run -d --name haproxy-healthcheck -p 8406:8406 -v $PWD/ansible/roles/haproxy/files/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro haproxy:3.0-alpine
    - sleep 3

    - echo "Checking HAProxy /stats endpoint..."
    - curl -sf http://127.0.0.1:8406/stats > /dev/null
    - echo "HAProxy health check PASSED"
  after_script:
    - docker rm -f haproxy-healthcheck || true
  only:
    - main


haproxy-deploy:
  stage: deploy
  tags:
    - shell-office-shared-runner
  needs:
    - haproxy-check
  script:
    - echo "ðŸš€ Deploying HAProxy via Ansible..."
    - ansible-playbook ansible/playbook/haproxy.yml -i ansible/inventory.yml
    - echo "âœ… HAProxy deployed successfully"
  only:
    - main

